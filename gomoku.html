<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gomoku - 20 √ó 27</title>

<style>
:root{
  --cols:20;
  --rows:27;
  --cell-size:28px;
}
body{
  margin:0;
  font-family: Arial, Helvetica, sans-serif;
  background: linear-gradient(135deg,#e9f0ff,#cfe8ff);
  display:flex;
  flex-direction:column;
  align-items:center;
  color:#111;
  min-height:100vh;
}
header{margin:18px 0;text-align:center;}
header h1{margin:0;font-size:24px;color:#0a3b6b;}
#infoBar{
  display:flex;gap:12px;align-items:center;margin:10px;
}
.badge{
  background:#fff;padding:8px 12px;border-radius:10px;
  box-shadow:0 6px 18px rgba(10,59,107,0.12);
  font-weight:600;border:3px solid rgba(10,59,107,0.12);
}
#boardWrap{
  background:#fff;padding:18px;border-radius:12px;
  border:8px solid #333;box-shadow:0 12px 40px rgba(0,0,0,0.25);
  margin:12px;
}
#board{
  display:grid;
  grid-template-columns:repeat(var(--cols),var(--cell-size));
  grid-template-rows:repeat(var(--rows),var(--cell-size));
  gap:4px;
  touch-action:manipulation;
  user-select:none;
}
.cell{
  width:var(--cell-size);height:var(--cell-size);
  background:rgba(0,0,0,0.02);
  display:flex;align-items:center;justify-content:center;
  border-radius:6px;border:2px solid rgba(0,0,0,0.05);
  transition:box-shadow .18s,transform .08s;
  cursor:pointer;position:relative;
}
.cell.lock{background:#ff9a3c;cursor:not-allowed;}
.cell.glow{box-shadow:0 0 0 3px rgba(255,215,0,0.45);}
.cell.last{outline:3px solid rgba(0,180,255,0.9);outline-offset:2px;}
.stone{
  width:70%;height:70%;border-radius:50%;
  box-shadow:0 8px 18px rgba(0,0,0,0.35),inset 0 6px 10px rgba(255,255,255,0.18);
  position:relative;z-index:3;
}
.stone.green{background:linear-gradient(180deg,#2bb673,#058a3d);}
.stone.red{background:linear-gradient(180deg,#ff5c5c,#c52828);}
#msg{margin-top:10px;font-weight:700;}
.muted{font-size:13px;color:#334;opacity:0.8;}
</style>
</head>

<body>
<header>
  <h1>Gomoku Online ‚Äî B√†n 20 √ó 27</h1>
  <div id="infoBar">
    <div class="badge" id="boardName">B√†n: ...</div>
    <div class="badge" id="players">--- vs ---</div>
    <div class="badge" id="turnInfo">L∆∞·ª£t: -</div>
    <div class="badge" id="timer">60s</div>
  </div>
  <div id="msg" class="muted"></div>
</header>

<main id="boardWrap"><div id="board"></div></main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, updateDoc, onSnapshot,
  arrayUnion, serverTimestamp, deleteDoc
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

// --- Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSyC5-cGz8AzOWvlF8-kyPRipujMeY2i1iRc",
  authDomain: "gomokuzb.firebaseapp.com",
  projectId: "gomokuzb",
  storageBucket: "gomokuzb.appspot.com",
  messagingSenderId: "669696092843",
  appId: "1:669696092843:web:b89092c51d212b631d25ee"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --- Elements ---
const cols=20, rows=27;
const boardEl=document.getElementById('board');
const boardNameEl=document.getElementById('boardName');
const playersEl=document.getElementById('players');
const turnInfoEl=document.getElementById('turnInfo');
const timerEl=document.getElementById('timer');
const msgEl=document.getElementById('msg');

// --- Info ---
const username=localStorage.getItem('username');
const IdBan=localStorage.getItem('IdBan');
if(!username||!IdBan){
  alert('Thi·∫øu username ho·∫∑c IdBan. Quay l·∫°i S·∫£nh Ch·ªù.');
  window.location.href='SanhCho.html';
}
const docRef=doc(db,'Ban',IdBan);

// --- Board setup ---
const cells=[];
for(let r=0;r<rows;r++){
  for(let c=0;c<cols;c++){
    const idx=r*cols+c;
    const cell=document.createElement('div');
    cell.className='cell';
    cell.dataset.idx=idx;
    cell.addEventListener('click',()=>onCellClick(idx));
    boardEl.appendChild(cell);
    cells.push(cell);
  }
}
const centerIdx=Math.floor(rows/2)*cols+Math.floor(cols/2);

// --- Audio ---
const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
function playClick(){const o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.type='square';o.frequency.value=900;g.gain.value=0.0001;o.connect(g);g.connect(audioCtx.destination);
  g.gain.exponentialRampToValueAtTime(0.16,audioCtx.currentTime+0.001);
  g.gain.exponentialRampToValueAtTime(0.00001,audioCtx.currentTime+0.12);
  o.start();o.stop(audioCtx.currentTime+0.13);
}
function playTick(){const o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.type='sine';o.frequency.value=1200;g.gain.value=0.0001;o.connect(g);g.connect(audioCtx.destination);
  g.gain.exponentialRampToValueAtTime(0.08,audioCtx.currentTime+0.001);
  g.gain.exponentialRampToValueAtTime(0.00001,audioCtx.currentTime+0.15);
  o.start();o.stop(audioCtx.currentTime+0.16);
}

// --- Helpers ---
const idxToRC=i=>({r:Math.floor(i/cols),c:i%cols});
const RCtoIdx=(r,c)=>r*cols+c;
const neighbors=i=>{
  const {r,c}=idxToRC(i);const a=[];
  for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++){
    if(dr||dc){const nr=r+dr,nc=c+dc;if(nr>=0&&nr<rows&&nc>=0&&nc<cols)a.push(RCtoIdx(nr,nc));}
  }return a;
};

// --- Game state ---
let state={moves:[],locks:[centerIdx],player1:null,player2:null,winner:null,tenBan:IdBan};
let myColor=null,isMyTurn=false,lastMove=null;
let timerHandle=null,TURN=60;
let timerStarted=false;

// --- Timer ---
function startTimer(){
  stopTimer();
  const end=Date.now()+TURN*1000;
  timerHandle=setInterval(()=>{
    const left=Math.max(0,Math.ceil((end-Date.now())/1000));
    timerEl.textContent=`${left}s`;
    if(left<=10&&left>0)playTick();
    if(left<=0){stopTimer();handleTimeout();}
  },250);
}
function stopTimer(){if(timerHandle){clearInterval(timerHandle);timerHandle=null;timerEl.textContent=`${TURN}s`;}}
async function handleTimeout(){
  const sym=(state.moves.length%2===0)?'green':'red';
  const win=(sym==='green')?'red':'green';
  await handleGameEnd(win);
}

// --- Update Score ---
async function updateScore(winnerUsername, loserUsername){
  try{
    const winnerSnap=await getDoc(doc(db,'users',winnerUsername));
    const loserSnap=await getDoc(doc(db,'users',loserUsername));
    if(winnerSnap.exists()){
      const cur=winnerSnap.data().DiemSo||0;
      await updateDoc(doc(db,'users',winnerUsername),{DiemSo:cur+1});
    }
    if(loserSnap.exists()){
      const cur=loserSnap.data().DiemSo||0;
      await updateDoc(doc(db,'users',loserUsername),{DiemSo:cur-1});
    }
  }catch(err){console.error('L·ªói c·∫≠p nh·∫≠t ƒëi·ªÉm:',err);}
}

// --- Render ---
function render(){
  cells.forEach(c=>{c.className='cell';c.innerHTML='';});
  state.locks.forEach(i=>cells[i]?.classList.add('lock'));
  state.moves.forEach((m,i)=>{
    const el=cells[m.pos];if(!el)return;
    const s=document.createElement('div');s.className=`stone ${m.symbol}`;el.appendChild(s);
    if(i===state.moves.length-1){el.classList.add('last');lastMove=m.pos;}
  });
  if(!state.moves.length)neighbors(centerIdx).forEach(i=>!state.locks.includes(i)&&cells[i].classList.add('glow'));
  playersEl.textContent=`${state.player1||'Tr·ªëng'} (Green) ‚Äî ${state.player2||'Tr·ªëng'} (Red)`;
  boardNameEl.textContent=`B√†n: ${state.tenBan||IdBan}`;
  const turnSym=(state.moves.length%2===0)?'green':'red';
  turnInfoEl.textContent=`L∆∞·ª£t: ${turnSym==='green'?'Green':'Red'}`;
  isMyTurn=(myColor===turnSym)&&!state.winner;
  msgEl.textContent=state.winner?`üéâ Ng∆∞·ªùi th·∫Øng: ${state.winner}`:'';
  if(state.winner)stopTimer();
}

// --- Handle game end ---
async function handleGameEnd(winnerSym){
  const winnerUsername=(winnerSym==='green')?state.player1:state.player2;
  const loserUsername=(winnerSym==='green')?state.player2:state.player1;
  await updateScore(winnerUsername,loserUsername);
  alert(`üéâ Ng∆∞·ªùi th·∫Øng l√†: ${winnerUsername}!`);
  try{
    await deleteDoc(doc(db,'Ban',IdBan));
  }catch{}
  localStorage.removeItem('IdBan');
  window.location.href='SanhCho.html';
}

// --- Join + Listen ---
let first=true,lastLen=0;
onSnapshot(docRef,async snap=>{
  if(!snap.exists()){alert('B√†n kh√¥ng t·ªìn t·∫°i!');return location.href='SanhCho.html';}
  const d=snap.data();state={...state,...d};
  if(!state.locks?.length)state.locks=[centerIdx];

  try{
    if(!state.player1) await updateDoc(docRef,{player1:username});
    else if(!state.player2&&state.player1!==username) await updateDoc(docRef,{player2:username});
  }catch{}

  const fresh=await getDoc(docRef);
  if(fresh.exists()) Object.assign(state,fresh.data());

  if(state.player1===username) myColor='green';
  else if(state.player2===username) myColor='red';

  // --- Start timer khi ƒë·ªß 2 ng∆∞·ªùi ---
  if(!timerStarted && state.player1 && state.player2){
    startTimer();
    timerStarted=true;
  }

  // check winner
  if(state.moves.length>lastLen){
    const w=checkWinner(state.moves);
    if(w&&!state.winner) await updateDoc(docRef,{winner:w,finishedAt:serverTimestamp()});
    playClick();
    startTimer();
  }
  render();first=false;lastLen=state.moves.length;

  if(state.winner) handleGameEnd(state.winner);
});

// --- Click handler ---
async function onCellClick(i){
  if(audioCtx.state==='suspended') audioCtx.resume();
  if(state.winner) return alert('Tr·∫≠n ƒë·∫•u ƒë√£ k·∫øt th√∫c.');
  if(!myColor) return alert('B·∫°n ch∆∞a ƒë∆∞·ª£c g√°n ng∆∞·ªùi ch∆°i.');
  if(!state.player1 || !state.player2) return alert('Ch∆∞a c√≥ ƒë·ªëi th·ªß, kh√¥ng th·ªÉ ƒë√°nh.');
  if(!isMyTurn) return alert('Ch∆∞a t·ªõi l∆∞·ª£t b·∫°n.');
  if(state.locks.includes(i)) return alert('√î b·ªã kh√≥a.');
  if(state.moves.some(m=>m.pos===i)) return;
  if(!state.moves.length && !neighbors(centerIdx).includes(i)) return alert('N∆∞·ªõc ƒë·∫ßu ph·∫£i g·∫ßn √¥ gi·ªØa.');
  await updateDoc(docRef,{moves: arrayUnion({pos:i, symbol: myColor, by: username})});
  playClick();
}

// --- Check th·∫Øng ---
function checkWinner(moves){
  const last=moves[moves.length-1];if(!last)return null;
  const sym=last.symbol,set=new Set(moves.filter(m=>m.symbol===sym).map(m=>m.pos));
  const dirs=[[1,0],[0,1],[1,1],[1,-1]];
  const {r,c}=idxToRC(last.pos);
  for(const [dr,dc]of dirs){
    let cnt=1;
    for(let s=1;s<5&&set.has(RCtoIdx(r+s*dr,c+s*dc));s++)cnt++;
    for(let s=1;s<5&&set.has(RCtoIdx(r-s*dr,c-s*dc));s++)cnt++;
    if(cnt>=5)return sym;
  }return null;
}

// --- X·ª≠ l√Ω ƒë√≥ng/tab out ---
window.addEventListener('beforeunload', async (e) => {
  if(state.player1===username && !state.player2){
    try{await deleteDoc(doc(db,'Ban',IdBan));localStorage.removeItem('IdBan');}catch{}
  } else if(state.player2===username && !state.player1){
    try{await deleteDoc(doc(db,'Ban',IdBan));localStorage.removeItem('IdBan');}catch{}
  }
});

document.addEventListener('click',()=>{if(audioCtx.state==='suspended')audioCtx.resume();},{once:true});
</script>
</body>
</html>
